(()=>{"use strict";class t{constructor(){this.bomb=!1,this.number=0,this.visible=!1,this.flagged=!1,this.hasExploded=!1}isFlagged(){return this.flagged}toggleFlag(){this.flagged=!this.flagged}isVisible(){return this.visible}setVisible(){this.visible=!0}hasBomb(){return this.bomb}setBomb(){this.bomb=!0}setExploded(){this.hasExploded=!0}getExploded(){return this.hasExploded}getNumber(){return this.number}setNumber(t){this.number=t}toString(){return this.bomb?"B":this.number.toString()}drawBomb(t,e,i,l,s,o){t.fillStyle="black",t.beginPath(),t.arc(e,i,l,0,2*Math.PI),t.fill(),t.closePath(),t.lineWidth=4,t.beginPath(),t.moveTo(e,i-l-s),t.lineTo(e,i+l+s),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e-l-s,i),t.lineTo(e+l+s,i),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e-l/1.5-s,i-l/1.5-s),t.lineTo(e+l/1.5+s,i+l/1.5+s),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e+l/1.5+s,i-l/1.5-s),t.lineTo(e-l/1.5-s,i+l/1.5+s),t.stroke(),t.closePath(),t.lineWidth=1;const r=t.createLinearGradient(e-l,i-l,e+l/2,i+l/2);r.addColorStop(0,"grey"),r.addColorStop(1,"black"),t.fillStyle=r,t.beginPath(),t.arc(e,i,l-2,0,2*Math.PI),t.fill(),t.closePath(),o?(t.fillStyle="red",t.beginPath(),t.arc(e,i,l/4,0,2*Math.PI),t.fill(),t.closePath()):(t.fillStyle="black",t.beginPath(),t.arc(e,i,l/4,0,2*Math.PI),t.fill(),t.closePath())}drawCellContent(t,e,i,l){const s=i*l+l/2,o=e*l+l/2,r=l/4;if(this.visible)if(this.hasBomb())this.getExploded()?this.drawBomb(t,s,o,r,4,!0):this.drawBomb(t,s,o,r,4);else{let s="#000000";if(1===this.getNumber())s="blue";else if(2===this.getNumber())s="green";else if(3===this.getNumber())s="red";else if(4===this.getNumber())s="#00008B";else if(5===this.getNumber())s="#8B0000";else if(6===this.getNumber())s="#00FFFF";else if(7===this.getNumber())s="black";else if(8===this.getNumber())s="grey";else if(0===this.getNumber())return;t.fillStyle="#f9f8f5",t.fillRect(i*l,e*l,l,l),t.fillStyle=s,t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.toString(),i*l+l/2,e*l+l/2)}else t.fillStyle="#999999",t.fillRect(i*l,e*l,l,l),this.flagged&&(t.fillStyle="#ff0000",t.beginPath(),t.moveTo(s-2,o+r),t.lineTo(s-3.5,o-1),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(s-3,o-1),t.lineTo(s-r/2,o-r-4),t.stroke(),t.lineTo(s+r+4,o-r/2-4),t.stroke(),t.lineTo(s-3,o-1),t.stroke(),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s-8,o+r),t.lineTo(s+4,o+r),t.stroke(),t.closePath())}}class e{DIFFICULTY_NORMAL=.15;constructor(e,i){this.length=e,this.width=i,this.matrix=[];for(let l=0;l<e;l++){let e=[];for(let l=0;l<i;l++){let i=new t;e.push(i)}this.matrix.push(e)}const l=Math.floor(e*i*this.DIFFICULTY_NORMAL);this.numbombs=l,this.placeBombs(l)}get numBomb(){return this.numbombs}placeBombs(t){const e=(t,e)=>Math.floor(Math.random()*(e-t+1))+t;let i=t;for(;i>0;){let t=(0,l=this.length-1,Math.floor(Math.random()*(l-0+1))+0),s=e(0,this.width-1);this.matrix[t][s].hasBomb()||(this.matrix[t][s].setBomb(),this.calculateCellWeight(t,s),i--)}var l}calculateCellWeight(t,e){t-1>=0&&t-1<this.length&&(e-1>=0&&e-1<this.width&&!this.matrix[t-1][e-1].hasBomb()&&this.matrix[t-1][e-1].setNumber(this.matrix[t-1][e-1].getNumber()+1),e>=0&&e<this.width&&!this.matrix[t-1][e].hasBomb()&&this.matrix[t-1][e].setNumber(this.matrix[t-1][e].getNumber()+1),e+1>=0&&e+1<this.width&&!this.matrix[t-1][e+1].hasBomb()&&this.matrix[t-1][e+1].setNumber(this.matrix[t-1][e+1].getNumber()+1)),t>=0&&t<this.length&&(e-1>=0&&e-1<this.width&&!this.matrix[t][e-1].hasBomb()&&this.matrix[t][e-1].setNumber(this.matrix[t][e-1].getNumber()+1),e+1>=0&&e+1<this.width&&!this.matrix[t][e+1].hasBomb()&&this.matrix[t][e+1].setNumber(this.matrix[t][e+1].getNumber()+1)),t+1>=0&&t+1<this.length&&(e-1>=0&&e-1<this.width&&!this.matrix[t+1][e-1].hasBomb()&&this.matrix[t+1][e-1].setNumber(this.matrix[t+1][e-1].getNumber()+1),e>=0&&e<this.width&&!this.matrix[t+1][e].hasBomb()&&this.matrix[t+1][e].setNumber(this.matrix[t+1][e].getNumber()+1),e+1>=0&&e+1<this.width&&!this.matrix[t+1][e+1].hasBomb()&&this.matrix[t+1][e+1].setNumber(this.matrix[t+1][e+1].getNumber()+1))}toString(){let t="";for(let e=0;e<this.length;e++){for(let i=0;i<this.width;i++)t+="| "+this.matrix[e][i].toString()+" |";t+="\n";for(let e=0;e<this.width;e++)t+="-----";t+="\n"}return t}revealCell(t,e,i){if(i)this.matrix[t][e].isVisible()||this.matrix[t][e].getExploded()||this.matrix[t][e].toggleFlag();else if(!this.matrix[t][e].isFlagged()&&!this.matrix[t][e].isVisible()&&(this.matrix[t][e].setVisible(),0===this.matrix[t][e].getNumber()&&!this.matrix[t][e].hasBomb())){const i=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];for(let[l,s]of i){let i=t+l,o=e+s;i>=0&&i<this.length&&o>=0&&o<this.width&&(this.matrix[i][o].isVisible()||this.revealCell(i,o))}}}revealNeighbours(t,e){let i=!1,l=[];const s=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],o=this.matrix[t][e].getNumber();let r=0;for(let[i,l]of s){let s=t+i,o=e+l;s>=0&&s<this.length&&o>=0&&o<this.width&&this.matrix[s][o].isFlagged()&&r++}if(console.log("revealNeighbours:",o,": ",r),r===o)for(let[o,r]of s){let s=t+o,h=e+r;if(s>=0&&s<this.length&&h>=0&&h<this.width&&!this.matrix[s][h].isVisible()&&(this.revealCell(s,h),this.matrix[s][h].hasBomb()&&!this.matrix[s][h].isFlagged())){i=!0;const t=s,e=h;l.push({bombRow:t,bombCol:e})}}return console.log("bombs: ",l),{isBomb:i,bombsList:l}}}document.addEventListener("DOMContentLoaded",(async function(){const t=document.getElementById("minesweeperCanvas"),i=t.getContext("2d");let l=1,s=!1;const o=document.getElementById("timer");let r=null,h=0,a=!1;const n=document.getElementById("bombsCanvas"),m=n.getContext("2d"),b=await fetch("/getGridInfo"),g=await b.json(),{rows:c,cols:d,bombs:f}=g,u=c,x=d,P=40;let B=P*x,v=P*u;function w(){a||(r=setInterval((()=>{h++,o.innerHTML=h.toString()}),1e3),a=!0)}function N(){a=!1,clearInterval(r)}function T(){for(let t=0;t<u;t++)for(let e=0;e<x;e++)if(I.matrix[t][e].hasBomb()&&!I.matrix[t][e].isVisible()&&!I.matrix[t][e].isFlagged())return!1;return!0}function C(){t.removeEventListener("click",y),t.removeEventListener("contextmenu",M)}function k(){s?document.getElementById("gameWin").style.display="flex":document.getElementById("gameOver").style.display="flex"}function p(){console.log("Game Over! You clicked on a bomb."),N(),S=!0,C(),k();for(let t=0;t<u;t++)for(let e=0;e<x;e++)I.matrix[t][e].hasBomb()&&I.matrix[t][e].setVisible();i.clearRect(0,0,t.width,t.height);for(let t=0;t<u;t++)for(let e=0;e<x;e++)I.matrix[t][e].drawCellContent(i,t,e,P),i.strokeRect(e*P,t*P,P,P)}function y(e){const o=t.getBoundingClientRect(),r=e.clientX-o.left,h=e.clientY-o.top,a=Math.floor(h/P*l),n=Math.floor(r/P*l);if(console.log(`Left-clicked on cell (${a}, ${n})`),w(),I.matrix[a][n].isVisible()){if(I.matrix[a][n].getNumber()>0&&!I.matrix[a][n].hasBomb()){const{isBomb:t,bombsList:e}=I.revealNeighbours(a,n);if(console.log(`isBomb: ${t}, bombList: ${e}`),t)for(const t of e){const e=t.bombRow,i=t.bombCol;I.matrix[e][i].getExploded()||p()}}}else I.revealCell(a,n,!1);i.clearRect(0,0,t.width,t.height);for(let t=0;t<u;t++)for(let e=0;e<x;e++)I.matrix[t][e].drawCellContent(i,t,e,P),i.strokeRect(e*P,t*P,P,P);!function(t,e){if(!I.matrix[t][e].isFlagged())return I.matrix[t][e].hasBomb()}(a,n)?T()&&(s=!0,N(),S=!0,C(),k()):p()}function M(e){e.preventDefault();const l=t.getBoundingClientRect(),o=e.clientX-l.left,r=e.clientY-l.top,h=Math.floor(r/P),a=Math.floor(o/P);console.log(`Right-clicked on cell (${h}, ${a})`),w(),I.revealCell(h,a,!0),i.clearRect(0,0,t.width,t.height);for(let t=0;t<u;t++)for(let e=0;e<x;e++)I.matrix[t][e].drawCellContent(i,t,e,P),i.strokeRect(e*P,t*P,P,P);I.matrix[h][a].isFlagged()?L.innerHTML=(parseInt(L.innerHTML)-1).toString():L.innerHTML=(parseInt(L.innerHTML)+1).toString(),T()&&(s=!0,N(),console.log("Game Over! You win!"),S=!0,C(),k())}t.width=B,t.height=v;let S=!1;t.addEventListener("click",y),t.addEventListener("contextmenu",M);const I=new e(u,x);n.width=P,n.height=P,function(t,e,i,l,s){t.fillStyle="black",t.beginPath(),t.arc(e,i,l,0,2*Math.PI),t.fill(),t.closePath(),t.lineWidth=4,t.beginPath(),t.moveTo(e,i-l-4),t.lineTo(e,i+l+4),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e-l-4,i),t.lineTo(e+l+4,i),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e-l/1.5-4,i-l/1.5-4),t.lineTo(e+l/1.5+4,i+l/1.5+4),t.stroke(),t.closePath(),t.beginPath(),t.moveTo(e+l/1.5+4,i-l/1.5-4),t.lineTo(e-l/1.5-4,i+l/1.5+4),t.stroke(),t.closePath(),t.lineWidth=1;const o=t.createLinearGradient(e-l,i-l,e+l/2,i+l/2);o.addColorStop(0,"grey"),o.addColorStop(1,"black"),t.fillStyle=o,t.beginPath(),t.arc(e,i,l-2,0,2*Math.PI),t.fill(),t.closePath(),t.fillStyle="black",t.beginPath(),t.arc(e,i,l/4,0,2*Math.PI),t.fill(),t.closePath()}(m,P/2,P/2,P/4);let L=document.getElementById("bombs");L.innerHTML=I.numbombs.toString();for(let t=0;t<u;t++)for(let e=0;e<x;e++)I.matrix[t][e].drawCellContent(i,t,e,P),i.strokeRect(e*P,t*P,P,P)}))})();